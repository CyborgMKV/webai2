<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry Corruption Fix Verification</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #0a0a0a; 
            color: #00ff00; 
            margin: 20px;
            line-height: 1.6;
        }
        .header { 
            text-align: center; 
            border: 2px solid #00ff00; 
            padding: 20px; 
            margin-bottom: 20px;
            background: rgba(0, 255, 0, 0.1);
        }
        .section { 
            border: 1px solid #00ff00; 
            padding: 15px; 
            margin: 10px 0; 
            background: rgba(0, 50, 0, 0.2);
        }
        .fix-button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        .fix-button:hover {
            background: #00cc00;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        .status.good { background: #004400; color: #00ff00; }
        .status.warning { background: #444400; color: #ffff00; }
        .status.error { background: #440000; color: #ff0000; }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border: 1px solid #00ff00;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß GEOMETRY CORRUPTION FIX VERIFICATION</h1>
        <p>Advanced repair tool for massive geometry corruption (76/77 failures)</p>
    </div>

    <div class="section">
        <h2>üìä Problem Analysis</h2>
        <div id="problemStatus">
            <span class="status error">76/77 Geometries Corrupted</span>
            <span class="status error">Console Spam Every 5 Seconds</span>
            <span class="status error">NaN Values in Player Model</span>
            <span class="status warning">13.5MB Model File Issues</span>
        </div>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è Applied Fixes</h2>
        <div id="fixesStatus">
            <span class="status good">‚úÖ Validation Frequency Reduced (30s)</span>
            <span class="status good">‚úÖ Console Logging Reduced</span>
            <span class="status good">‚úÖ Advanced Repair Tool Added</span>
            <span class="status good">‚úÖ Batch Geometry Processing</span>
        </div>
    </div>

    <div class="section">
        <h2>üéÆ Live Testing</h2>
        <p>Click the buttons below to test the fixes:</p>
        
        <button class="fix-button" onclick="testGeometryRepair()">Test Geometry Repair Tool</button>
        <button class="fix-button" onclick="checkConsoleSpam()">Check Console Spam Reduction</button>
        <button class="fix-button" onclick="validateModelLoading()">Validate Model Loading</button>
        <button class="fix-button" onclick="runFullSystemTest()">Run Full System Test</button>
    </div>

    <div class="section">
        <h2>üìù Console Output</h2>
        <div id="consoleOutput" class="console-output">Waiting for test results...\n</div>
    </div>

    <div class="section">
        <h2>üìà System Health</h2>
        <div id="systemHealth">
            <div>Geometry Repair Tool: <span id="repairToolStatus">Ready</span></div>
            <div>Console Spam Level: <span id="spamLevel">Reduced</span></div>
            <div>Validation Frequency: <span id="validationFreq">30 seconds</span></div>
            <div>Repair Success Rate: <span id="repairRate">Pending</span></div>
        </div>
    </div>

    <script>
        let logOutput = '';
        
        function log(message) {
            logOutput += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            document.getElementById('consoleOutput').textContent = logOutput;
            document.getElementById('consoleOutput').scrollTop = document.getElementById('consoleOutput').scrollHeight;
        }
        
        function updateStatus(elementId, text, className = 'good') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                element.className = `status ${className}`;
            }
        }
        
        async function testGeometryRepair() {
            log('üîß Testing Geometry Repair Tool...');
            
            try {
                // Check if repair tool is available globally
                if (typeof window.debugGeometryRepair !== 'undefined') {
                    log('‚úÖ Geometry Repair Tool found in global scope');
                    
                    const stats = window.debugGeometryRepair.getStats();
                    log(`üìä Repair Stats: ${JSON.stringify(stats, null, 2)}`);
                    
                    updateStatus('repairToolStatus', 'Active & Ready', 'good');
                    
                    // Test repair on current scene if available
                    if (typeof window.debugGame !== 'undefined' && window.debugGame.app?.scene) {
                        log('üéÆ Testing repair on current scene...');
                        const scene = window.debugGame.app.scene;
                        const repairResult = window.debugGeometryRepair.batchRepairGeometries(scene);
                        log(`üî® Batch Repair Result: ${JSON.stringify(repairResult, null, 2)}`);
                        
                        if (repairResult.geometriesRepaired > 0) {
                            updateStatus('repairRate', `${repairResult.geometriesRepaired}/${repairResult.geometriesProcessed} repaired`, 'good');
                        }
                    }
                } else {
                    log('‚ùå Geometry Repair Tool not found - may not be loaded yet');
                    updateStatus('repairToolStatus', 'Not Found', 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing repair tool: ${error.message}`);
                updateStatus('repairToolStatus', 'Error', 'error');
            }
        }
        
        function checkConsoleSpam() {
            log('üì¢ Checking console spam reduction...');
            
            // Monitor console for validation messages
            const originalLog = console.log;
            const originalWarn = console.warn;
            let validationMessages = 0;
            let spamMessages = 0;
            
            const startTime = Date.now();
            
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('validateSceneGeometry') || message.includes('Geometry validation failed')) {
                    validationMessages++;
                    if (validationMessages > 5) spamMessages++;
                }
                originalLog.apply(console, args);
            };
            
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('geometry') || message.includes('validation')) {
                    validationMessages++;
                    if (validationMessages > 5) spamMessages++;
                }
                originalWarn.apply(console, args);
            };
            
            setTimeout(() => {
                console.log = originalLog;
                console.warn = originalWarn;
                
                log(`üìä Console monitoring complete (10s):`);
                log(`   Validation messages: ${validationMessages}`);
                log(`   Spam threshold exceeded: ${spamMessages > 0 ? 'Yes' : 'No'}`);
                
                if (spamMessages === 0) {
                    updateStatus('spamLevel', 'Significantly Reduced', 'good');
                    log('‚úÖ Console spam successfully reduced!');
                } else {
                    updateStatus('spamLevel', 'Still High', 'warning');
                    log('‚ö†Ô∏è Console spam still detected - may need additional fixes');
                }
            }, 10000);
            
            log('‚è±Ô∏è Monitoring console for 10 seconds...');
        }
        
        function validateModelLoading() {
            log('üì¶ Validating model loading improvements...');
            
            if (typeof window.debugGame !== 'undefined' && window.debugGame.app) {
                const app = window.debugGame.app;
                
                // Check if loadModel function has been updated
                if (app.loadModel.toString().includes('geometryRepairTool')) {
                    log('‚úÖ LoadModel function updated with repair tool');
                    log('‚úÖ Batch processing enabled');
                    log('‚úÖ Reduced logging implemented');
                } else {
                    log('‚ùå LoadModel function not updated');
                }
                
                // Check scene objects
                let meshCount = 0;
                let geometryCount = 0;
                
                app.scene.traverse((obj) => {
                    if (obj.isMesh) {
                        meshCount++;
                        if (obj.geometry) geometryCount++;
                    }
                });
                
                log(`üìä Current scene stats:`);
                log(`   Meshes: ${meshCount}`);
                log(`   Geometries: ${geometryCount}`);
                
                if (geometryCount > 0) {
                    log('‚úÖ Geometries successfully loaded and rendered');
                }
            } else {
                log('‚ùå Game instance not available for testing');
            }
        }
        
        async function runFullSystemTest() {
            log('üöÄ Running full system test...');
            log('=================================');
            
            await testGeometryRepair();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            validateModelLoading();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            checkConsoleSpam();
            
            log('=================================');
            log('‚úÖ Full system test initiated');
            log('üìä Monitor results above for 10 seconds');
        }
        
        // Auto-start basic checks when page loads
        setTimeout(() => {
            log('üîÑ Initializing verification system...');
            testGeometryRepair();
        }, 1000);
    </script>
</body>
</html>

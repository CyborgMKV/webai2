<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAI 3D - System Health Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f23, #1a1a3a);
            color: #e6e6e6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #00ff88;
            font-size: 2.5em;
            text-shadow: 0 0 10px #00ff88;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #888;
            font-size: 1.1em;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .status-card h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            padding-bottom: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .status-label {
            color: #ccc;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        .status-good {
            color: #00ff88;
        }
        
        .status-warning {
            color: #ffaa00;
        }
        
        .status-error {
            color: #ff4444;
        }
        
        .logs-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .logs-section h3 {
            color: #00ff88;
            margin-bottom: 15px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .log-info {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }
        
        .log-warn {
            background: rgba(255, 170, 0, 0.1);
            border-left: 3px solid #ffaa00;
        }
        
        .log-error {
            background: rgba(255, 68, 68, 0.1);
            border-left: 3px solid #ff4444;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .timestamp {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .health-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üõ°Ô∏è WebAI 3D System Health</h1>
            <div class="subtitle">Real-time monitoring of WebGL context, geometry validation, and system status</div>
        </div>
        
        <div class="timestamp" id="timestamp">
            Last Updated: <span id="lastUpdate">Loading...</span>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="btn" onclick="validateGeometry()">üîç Validate Geometry</button>
            <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button class="btn" onclick="exportReport()">üìä Export Report</button>
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>
                    <span class="health-indicator pulse" id="webglIndicator"></span>
                    WebGL Context
                </h3>
                <div class="status-item">
                    <span class="status-label">Context Status:</span>
                    <span class="status-value" id="contextStatus">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Context Lost Count:</span>
                    <span class="status-value" id="contextLostCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Context Restore Count:</span>
                    <span class="status-value" id="contextRestoreCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Validation Count:</span>
                    <span class="status-value" id="webglValidationCount">0</span>
                </div>
            </div>
            
            <div class="status-card">
                <h3>
                    <span class="health-indicator pulse" id="geometryIndicator"></span>
                    Geometry Health
                </h3>
                <div class="status-item">
                    <span class="status-label">Total Validations:</span>
                    <span class="status-value" id="geometryValidations">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Repair Operations:</span>
                    <span class="status-value" id="geometryRepairs">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Reconstructions:</span>
                    <span class="status-value" id="geometryReconstructions">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Invalid Values Found:</span>
                    <span class="status-value" id="invalidValues">0</span>
                </div>
            </div>
            
            <div class="status-card">
                <h3>
                    <span class="health-indicator pulse" id="sceneIndicator"></span>
                    Scene Status
                </h3>
                <div class="status-item">
                    <span class="status-label">Total Objects:</span>
                    <span class="status-value" id="totalObjects">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Mesh Count:</span>
                    <span class="status-value" id="meshCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Geometry Count:</span>
                    <span class="status-value" id="geometryCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Scene Health:</span>
                    <span class="status-value" id="sceneHealth">Good</span>
                </div>
            </div>
            
            <div class="status-card">
                <h3>
                    <span class="health-indicator pulse" id="gameIndicator"></span>
                    Game Status
                </h3>
                <div class="status-item">
                    <span class="status-label">Game Running:</span>
                    <span class="status-value" id="gameRunning">No</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Entity Count:</span>
                    <span class="status-value" id="entityCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Physics Enabled:</span>
                    <span class="status-value" id="physicsEnabled">No</span>
                </div>
                <div class="status-item">
                    <span class="status-label">System Status:</span>
                    <span class="status-value" id="systemStatus">Initializing</span>
                </div>
            </div>
        </div>
        
        <div class="logs-section">
            <h3>üìã System Logs</h3>
            <div id="logs">
                <div class="log-entry log-info">
                    <strong>[INFO]</strong> Health dashboard initialized
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let logs = [];
        let maxLogs = 100;
        
        // Try to connect to the game instance
        function getGameInstance() {
            try {
                if (window.opener && window.opener.app) {
                    return window.opener.app;
                } else if (window.parent && window.parent.app) {
                    return window.parent.app;
                } else if (window.top && window.top.app) {
                    return window.top.app;
                } else {
                    // Try to access through iframe or new window context
                    return null;
                }
            } catch (e) {
                console.warn('Cannot access game instance:', e);
                return null;
            }
        }
        
        function addLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, level, message };
            logs.unshift(logEntry);
            
            if (logs.length > maxLogs) {
                logs = logs.slice(0, maxLogs);
            }
            
            updateLogsDisplay();
        }
        
        function updateLogsDisplay() {
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = logs.map(log => 
                `<div class="log-entry log-${log.level}">
                    <strong>[${log.timestamp}] [${log.level.toUpperCase()}]</strong> ${log.message}
                </div>`
            ).join('');
        }
        
        function updateHealthIndicator(elementId, isHealthy) {
            const indicator = document.getElementById(elementId);
            if (isHealthy) {
                indicator.style.backgroundColor = '#00ff88';
                indicator.classList.remove('pulse');
            } else {
                indicator.style.backgroundColor = '#ff4444';
                indicator.classList.add('pulse');
            }
        }
        
        function refreshData() {
            const app = getGameInstance();
            
            if (!app) {
                addLog('warn', 'Cannot connect to game instance. Make sure this dashboard is opened from the game.');
                document.getElementById('lastUpdate').textContent = 'Connection Failed';
                return;
            }
            
            try {
                const health = app.getSystemHealth();
                updateDisplay(health);
                addLog('info', 'System health data refreshed successfully');
            } catch (error) {
                addLog('error', `Failed to get health data: ${error.message}`);
            }
        }
        
        function updateDisplay(health) {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // WebGL Status
            const contextHealthy = !health.webgl.contextLost;
            document.getElementById('contextStatus').textContent = contextHealthy ? 'Active' : 'Lost';
            document.getElementById('contextStatus').className = `status-value ${contextHealthy ? 'status-good' : 'status-error'}`;
            document.getElementById('contextLostCount').textContent = health.webgl.contextLostCount;
            document.getElementById('contextRestoreCount').textContent = health.webgl.contextRestoreCount;
            document.getElementById('webglValidationCount').textContent = health.webgl.geometryValidationCount || 0;
            updateHealthIndicator('webglIndicator', contextHealthy);
            
            // Geometry Health
            const geometryHealthy = health.geometry.totalInvalidValues === 0;
            document.getElementById('geometryValidations').textContent = health.geometry.validationCount;
            document.getElementById('geometryRepairs').textContent = health.geometry.repairCount;
            document.getElementById('geometryReconstructions').textContent = health.geometry.reconstructionCount;
            document.getElementById('invalidValues').textContent = health.geometry.totalInvalidValues;
            updateHealthIndicator('geometryIndicator', geometryHealthy);
            
            // Scene Status
            const sceneHealthy = health.scene.geometryCount > 0;
            document.getElementById('totalObjects').textContent = health.scene.totalObjects;
            document.getElementById('meshCount').textContent = health.scene.meshCount;
            document.getElementById('geometryCount').textContent = health.scene.geometryCount;
            document.getElementById('sceneHealth').textContent = sceneHealthy ? 'Good' : 'Warning';
            document.getElementById('sceneHealth').className = `status-value ${sceneHealthy ? 'status-good' : 'status-warning'}`;
            updateHealthIndicator('sceneIndicator', sceneHealthy);
            
            // Game Status
            const gameHealthy = health.game.running && health.game.physicsEnabled;
            document.getElementById('gameRunning').textContent = health.game.running ? 'Yes' : 'No';
            document.getElementById('gameRunning').className = `status-value ${health.game.running ? 'status-good' : 'status-warning'}`;
            document.getElementById('entityCount').textContent = health.game.entityCount;
            document.getElementById('physicsEnabled').textContent = health.game.physicsEnabled ? 'Yes' : 'No';
            document.getElementById('physicsEnabled').className = `status-value ${health.game.physicsEnabled ? 'status-good' : 'status-warning'}`;
            
            const systemHealthy = contextHealthy && geometryHealthy && gameHealthy;
            document.getElementById('systemStatus').textContent = systemHealthy ? 'Healthy' : 'Issues Detected';
            document.getElementById('systemStatus').className = `status-value ${systemHealthy ? 'status-good' : 'status-error'}`;
            updateHealthIndicator('gameIndicator', gameHealthy);
        }
        
        function validateGeometry() {
            const app = getGameInstance();
            if (!app) {
                addLog('warn', 'Cannot validate geometry - no game connection');
                return;
            }
            
            try {
                app.validateSceneGeometry();
                addLog('info', 'Manual geometry validation completed');
                setTimeout(refreshData, 100); // Refresh after validation
            } catch (error) {
                addLog('error', `Geometry validation failed: ${error.message}`);
            }
        }
        
        function clearLogs() {
            logs = [];
            updateLogsDisplay();
            addLog('info', 'Logs cleared');
        }
        
        function exportReport() {
            const app = getGameInstance();
            if (!app) {
                addLog('warn', 'Cannot export report - no game connection');
                return;
            }
            
            try {
                const health = app.getSystemHealth();
                const report = {
                    timestamp: new Date().toISOString(),
                    health,
                    logs: logs.slice(0, 50) // Last 50 logs
                };
                
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `webai3d-health-report-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                addLog('info', 'Health report exported successfully');
            } catch (error) {
                addLog('error', `Failed to export report: ${error.message}`);
            }
        }
        
        // Auto-refresh every 5 seconds
        setInterval(refreshData, 5000);
        
        // Initial load
        setTimeout(refreshData, 1000);
        
        // Add some initial logs
        addLog('info', 'Dashboard started');
        addLog('info', 'Attempting to connect to game instance...');
    </script>
</body>
</html>
